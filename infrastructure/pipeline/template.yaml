AWSTemplateFormatVersion: 2010-09-09
Description: The Monster of the Week Pipeline

Parameters:
  GitHubRepo:
    Type: String
    AllowedPattern: "[A-Za-z0-9-]+"
    Default: monster-of-week
  GitHubBranch:
    Type: String
    AllowedPattern: "[A-Za-z0-9-]+"
    Default: master

Conditions:
  IsProduction: !Equals [!Ref GitHubBranch, "master"]

Resources:
  BuildRunner:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub ${AWS::StackName}-BuildRunner
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_MEDIUM
        Image: aws/codebuild/standard:6.0
        Type: LINUX_CONTAINER
        EnvironmentVariables:
          - Name: BUILD_OUTPUT_BUCKET
            Value: !ImportValue ArtifactBucketId
          - Name: S3_BUCKET
            Value: !ImportValue ArtifactBucketId
      ServiceRole: !ImportValue BuildExecutionRoleArn
      Source:
        Type: CODEPIPELINE
        BuildSpec: infrastructure/pipeline/buildspec-build.yaml

  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      Name: !Sub ${AWS::StackName}
      ArtifactStore:
        Type: S3
        Location: !ImportValue ArtifactBucketId
      RestartExecutionOnUpdate: true
      RoleArn: !ImportValue PipelineInfrastructureRoleArn
      Stages:
        - Name: Source
          Actions:
            - Name: GithubSource
              InputArtifacts: []
              OutputArtifacts:
                - Name: SourceCode
              ActionTypeId:
                Category: Source
                Owner: AWS
                Version: 1
                Provider: CodeStarSourceConnection
              Configuration:
                ConnectionArn: arn:aws:codestar-connections:us-east-2:625961017727:connection/760e3889-f416-44aa-9c62-001a92098608
                FullRepositoryId: "evenflow58/monster-of-week"
                BranchName: !If [IsProduction, 'master', !Ref GitHubBranch]
                OutputArtifactFormat: "CODE_ZIP"
              RunOrder: 1
        - Name: Build
          Actions:
          - Name: Build
            ActionTypeId:
              Category: Build
              Owner: AWS
              Version: 1
              Provider: CodeBuild
            Configuration:
              ProjectName: !Ref BuildRunner
            InputArtifacts:
              - Name: SourceCode
            OutputArtifacts:
              - Name: uiBuildOutput
              - Name: lambdaEdgeBuildOutput
              - Name: apiGatewayBuildOutput
              - Name: apiGatewayDeploymentBuildOutput
              - Name: testGetBuildOutput
            RunOrder: 1
        - Name: !If [IsProduction, 'Staging', !Ref GitHubBranch]
          Actions:
            - Name: DeployUiCode
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: S3
                Version: 1
              RunOrder: 1
              Configuration:
                BucketName: !ImportValue UiBucketName
                Extract: true
                ObjectKey: !If [IsProduction, 'master', !Ref GitHubBranch]
              InputArtifacts:
                - Name: uiBuildOutput
              Region: us-east-1
            - Name: CreateUIChangeSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: 1
              Configuration:
                ActionMode: CHANGE_SET_REPLACE
                RoleArn: !ImportValue CloudFormationExecutionRoleArn
                StackName: !Sub '${AWS::StackName}-Stack-UI'
                ChangeSetName: ui
                TemplatePath: lambdaEdgeBuildOutput::infrastructure/template.package.yaml
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                ParameterOverrides: !Sub
                  - '{ "Domain": "${SubDomain}.monsterplaybook.rip", "BranchName": "${BranchName}" }'
                  - SubDomain: !If [IsProduction, 'staging', !Ref GitHubBranch]
                    BranchName: !Ref GitHubBranch
              InputArtifacts:
                - Name: lambdaEdgeBuildOutput
              RunOrder: 1
            - Name: CreateApiChangeSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: 1
              InputArtifacts:
                - Name: apiGatewayBuildOutput
              Configuration:
                ActionMode: CHANGE_SET_REPLACE
                RoleArn: !ImportValue CloudFormationExecutionRoleArn
                StackName: !Sub '${AWS::StackName}-Stack-Api'
                ChangeSetName: api
                TemplatePath: apiGatewayBuildOutput::infrastructure/template.package.yaml
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
              RunOrder: 1
            - Name: CreateApiDeploymentChangeSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: 1
              InputArtifacts:
                - Name: apiGatewayDeploymentBuildOutput
              Configuration:
                ActionMode: CHANGE_SET_REPLACE
                RoleArn: !ImportValue CloudFormationExecutionRoleArn
                StackName: !Sub '${AWS::StackName}-Stack-Api-Deployment'
                ChangeSetName: api-deployment
                TemplatePath: apiGatewayDeploymentBuildOutput::infrastructure/template.package.yaml
                Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                ParameterOverrides: !Sub
                  - '{ "BasePathDomain": "${BasePathDomain}", "StageName": "${StageName}" } '
                  - BasePathDomain: !If [IsProduction, 'api.monsterplaybook.rip', !Sub 'api-${GitHubBranch}.monsterplaybook.rip']
                    StageName: !If [IsProduction, 'staging', 'prod']
              RunOrder: 1
            - Name: ExecuteApiChangeSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: 1
              Configuration:
                ActionMode: CHANGE_SET_EXECUTE
                RoleArn: !ImportValue CloudFormationExecutionRoleArn
                StackName: !Sub '${AWS::StackName}-Stack-Api'
                ChangeSetName: api
              OutputArtifacts:
                - Name: !Sub '${AWS::StackName}-ChangeSet-Api-Deploy'
              RunOrder: 2
            - Name: ExecuteUIChangeSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: 1
              Configuration:
                ActionMode: CHANGE_SET_EXECUTE
                RoleArn: !ImportValue CloudFormationExecutionRoleArn
                StackName: !Sub '${AWS::StackName}-Stack-UI'
                ChangeSetName: ui
              OutputArtifacts:
                - Name: !Sub '${AWS::StackName}-ChangeSet-UI-Deploy'
              RunOrder: 3
            - Name: ExecuteApiDeploymentChangeSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: 1
              Configuration:
                ActionMode: CHANGE_SET_EXECUTE
                RoleArn: !ImportValue CloudFormationExecutionRoleArn
                StackName: !Sub '${AWS::StackName}-Stack-Api-Deployment'
                ChangeSetName: api-deployment
              OutputArtifacts:
                - Name: !Sub '${AWS::StackName}-ChangeSet-Api-Deployment-Deploy'
              RunOrder: 3
        - !If
          - IsProduction
          - Name: DeploymentApproval
            Actions:
              - Name: Approval
                ActionTypeId:
                  Category: Approval
                  Owner: AWS
                  Provider: Manual
                  Version: 1
                RunOrder: 1
          - !Ref AWS::NoValue
        - !If
          - IsProduction
          - Name: Production
            Actions:
              - Name: DeployUiCode
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: S3
                  Version: 1
                RunOrder: 1
                Configuration:
                  BucketName: !ImportValue UiBucketName
                  Extract: true
                  ObjectKey: master
                InputArtifacts:
                  - Name: uiBuildOutput
                Region: us-east-1
              - Name: CreateUIChangeSet
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: CloudFormation
                  Version: 1
                Configuration:
                  ActionMode: CHANGE_SET_REPLACE
                  RoleArn: !ImportValue CloudFormationExecutionRoleArn
                  StackName: 'prod-Stack-UI'
                  ChangeSetName: ui
                  TemplatePath: lambdaEdgeBuildOutput::infrastructure/template.package.yaml
                  Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                  ParameterOverrides: '{ "Domain": "monsterplaybook.rip", "BranchName": "master" }'
                InputArtifacts:
                  - Name: lambdaEdgeBuildOutput
                RunOrder: 1
              - Name: CreateApiChangeSet
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: CloudFormation
                  Version: 1
                InputArtifacts:
                  - Name: apiGatewayBuildOutput
                Configuration:
                  ActionMode: CHANGE_SET_REPLACE
                  RoleArn: !ImportValue CloudFormationExecutionRoleArn
                  StackName: 'prod-Stack-Api'
                  ChangeSetName: api
                  TemplatePath: apiGatewayBuildOutput::infrastructure/template.package.yaml
                  Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                  ParameterOverrides: '{ "BasePathDomain": "api.monsterplaybook.rip" }'
                RunOrder: 1
              - Name: CreateApiDeploymentChangeSet
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: CloudFormation
                  Version: 1
                InputArtifacts:
                  - Name: apiGatewayDeploymentBuildOutput
                Configuration:
                  ActionMode: CHANGE_SET_REPLACE
                  RoleArn: !ImportValue CloudFormationExecutionRoleArn
                  StackName: !Sub 'prod-Stack-Api-Deployment'
                  ChangeSetName: api-deployment
                  TemplatePath: apiGatewayDeploymentBuildOutput::infrastructure/template.package.yaml
                  Capabilities: CAPABILITY_IAM,CAPABILITY_AUTO_EXPAND
                  ParameterOverrides: '{ "StageName": "test" }'
                RunOrder: 1
              - Name: ExecuteApiChangeSet
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: CloudFormation
                  Version: 1
                Configuration:
                  ActionMode: CHANGE_SET_EXECUTE
                  RoleArn: !ImportValue CloudFormationExecutionRoleArn
                  StackName: !Sub 'prod-Stack-Api'
                  ChangeSetName: api
                OutputArtifacts:
                  - Name: !Sub 'prod-ChangeSet-Api-Deploy'
                RunOrder: 2
              - Name: ExecuteUIChangeSet
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: CloudFormation
                  Version: 1
                Configuration:
                  ActionMode: CHANGE_SET_EXECUTE
                  RoleArn: !ImportValue CloudFormationExecutionRoleArn
                  StackName: !Sub '$prod-Stack-UI'
                  ChangeSetName: ui
                OutputArtifacts:
                  - Name: !Sub 'prod-ChangeSet-UI-Deploy'
                RunOrder: 3
              - Name: ExecuteApiDeploymentChangeSet
                ActionTypeId:
                  Category: Deploy
                  Owner: AWS
                  Provider: CloudFormation
                  Version: 1
                Configuration:
                  ActionMode: CHANGE_SET_EXECUTE
                  RoleArn: !ImportValue CloudFormationExecutionRoleArn
                  StackName: !Sub 'prod-Stack-Api-Deployment'
                  ChangeSetName: api-deployment
                OutputArtifacts:
                  - Name: !Sub 'prod-ChangeSet-Api-Deployment-Deploy'
                RunOrder: 3
          - !Ref AWS::NoValue